---
title: "Data Clean Sarah"
format: html
editor: visual
---

## Loading Packages:

```{r}
library("tidyverse")
library("httr")
library("readr")
library("broom")
library("ggrepel")
```

## Load Data:

```{r}
data <- read_tsv("../data/03_dat_aug.tsv")

data
```

## Calculation of Average and Individual Log2 Fold Change:

```{r}
data_clean <- read_tsv("../data/02_dat_clean.tsv")
data_clean <- data_clean |>
  group_by(gene) |>
  mutate(log2_fold_change_avg = log2(mean(gene_expression[Metastasis == 1]) / 
                                 mean(gene_expression[Metastasis == 0])),
         log2_fold_change_ind = ifelse(Metastasis == 0,  # If Metastasis is equal to 0
                                   NA,               # Set log2_fold_change as NA
                                   log2(gene_expression / 
                                        mean(gene_expression[Metastasis == 0]))),
         p_value = t.test(gene_expression ~ Metastasis)$p.value) 
  
data_clean
```

```{r}
data_clean |> 
  select(gene, log2_fold_change_avg, p_value) |>
  unique() |>
  mutate(log_10_p = -log10(p_value),
         Significance = case_when(p_value > 0.001 ~ "Not Significant",
                                    p_value <= 0.001 ~ "Significant")) |> 
  ggplot(mapping = aes(x = log2_fold_change_avg,
                       y = log_10_p,
                       color = Significance)) +
  geom_point(size = 1, alpha = 0.5) +
  geom_hline(yintercept=3,
             linetype="dotted", 
             color = "black", 
             size=0.5) +
  theme(legend.position = "none") + 
  theme_minimal() +
  labs(title="Genes Associated with Metastasis in Bladder Cancer", 
     x = "Log2 Fold Change",
     y = "-log10(p)")
```

## Analysis 1:

In the first analysis, we want to investigate the gene expression regulation of the genes that were found to be significantly associated to metastatic bladder cancer. The significance was calculated on the basis of a students T-test where the expression of each gene was compared based on if the patients had metastatic cancer or not.

From the T-test, 286 genes were found to be significantly different expressed in observations with metastatic cancer compared to observations without metastatic cancer. These genes were selected based on a significance level of 0.01.

To further investigate if the significant genes are up-regulated or down-regulated, we calculated the Log2-Fold-Change. This was calculated by comparing the gene expression in samples with metastasis to the average gene expression across samples without metastasis for each gene. The formula for a specific gene in observation X is:

$$
\text{Log2 Fold Change}(X) = \log_2\left(\frac{\text{gene expression}_{\text{metastasis}}(X)}{\text{mean}(\text{gene expression}_{\text{no-metastasis}})}\right)
$$

The figure below shows the top 36 most significant genes, and their mean Log2 Fold Change value (circle), together with their lower and upper 95% confidence intervals (bars).

```{r}
data_clean |>
  group_by(gene) |>
  filter(Metastasis == 1) |>
  filter(p_value < 0.001) |>
  ggplot(aes(x = log2_fold_change_ind,
             y = reorder(gene, 
                         log2_fold_change_ind, 
                         FUN = mean))) + 
  stat_summary(fun.data = mean_cl_normal, 
               geom = "point", 
               shape = 20, 
               size = 2, 
               color = "black") +
  stat_summary(fun.data = mean_cl_normal, 
               geom = "errorbar", 
               width = 0.7, 
               color = "black", 
               size = 1) + 
  geom_vline(xintercept = 0, 
             linetype="dotted", 
             color = "blue", 
             size=1) + 
  xlab("Log2 Fold Change") + 
  ylab("Genes") + 
  ggtitle("Genes Associated with Metastasis in Bladder Cancer")
```

## Analysis 2:

In this analysis, we're exploring the potential relationship between smoking habits and the altered regulation of gene expression. Each gene in our dataset represents variation in gene expression across different patients. Interestingly, many genes exhibit both up-regulation and down-regulation patterns, which vary among individual patients.

To understand this relationship, we aim to investigate the proportion of Current Smokers, Former Smokers, and Non-smokers for each gene. Additionally, we want to compare these proportions based on how the gene expression is regulated (whether a gene is up-regulated or down-regulated).

```{r}
data_clean |>
  mutate(is_metastasis = case_when(Metastasis == 0 ~ "No Metastasis",
                                   Metastasis == 1 ~ "Metastasis")) |>
  ggplot(aes(x = "", fill=Smoking)) + 
  geom_bar(position = "fill") + 
  facet_wrap(~is_metastasis) + 
  ggtitle("Proportion of Smokers in samples grouped by Metastasis")

```

```{r}
data_clean |>
  filter(Metastasis == 1) |>
  filter(p_value < 0.001) |>
  mutate(Regulation = case_when(log2_fold_change_ind > 0 ~ "Samples with upregulation",
                                 log2_fold_change_ind < 0 ~ "Samples with downregulation",
                                 log2_fold_change_ind == 0 ~ "Unchanged"),
         Avg_Regulation = case_when(log2_fold_change_avg < 0 ~ "Avg. downregulation",
                                    log2_fold_change_avg > 0 ~ "Avg. upregulation")) |>
    ggplot(aes(y = reorder(gene,
                         log2_fold_change_ind, 
                         FUN = mean),
               fill = Smoking)) +
      geom_bar(position = "fill") +
      facet_grid(Avg_Regulation ~ Regulation, scales="free", space = "free") +
      labs(x = "Percentage", y = "Genes") +
      ggtitle("") 
```
