---
title: "06_analysis_2.qmd"
format: html
editor: visual
---

## Library Load

```{r}
library(tidyverse)
library(readr)
```

## Data Load

```{r}
data <- read_tsv("../data/03_dat_aug.tsv")
data
```

## Analysis 2

In this analysis, we want to explore the potential relationship between smoking habits and the altered regulation of gene expression. Each gene in our dataset represents variation in gene expression across different patients. Interestingly, many genes exhibit both up-regulation and down-regulation patterns, which vary among individual patients.

We select the top 13 most significant genes from our previous analysis. To further investigate the regulation of gene expression for each patient with metastasis, we calculate a Log2 Fold Change value for each patient. This was calculated by comparing the gene expression in samples with metastasis to the average gene expression across samples without metastasis for each gene. The formula for a specific gene in observation X is:

$$
\text{Log2 Fold Change}(X) = \log_2\left(\frac{\text{gene expression}_{\text{metastasis}}(X)}{\text{mean}(\text{gene expression}_{\text{no-metastasis}})}\right)
$$

This figure shows the top 13 most significant genes, and their mean Log2 Fold Change value (circle), together with their lower and upper 95% confidence intervals (bars).

```{r}
conf_int_plot <- data |>
  group_by(gene) |>
  filter(Metastasis == 1) |>
  filter(p_value < 0.001) |>
  ggplot(aes(x = log2_fold_change_sample,
             y = reorder(gene, 
                         log2_fold_change_sample, 
                         FUN = mean))) + 
  stat_summary(fun.data = mean_cl_normal, 
               geom = "point", 
               shape = 20, 
               size = 2, 
               color = "black") +
  stat_summary(fun.data = mean_cl_normal, 
               geom = "errorbar", 
               width = 0.7, 
               color = "black", 
               size = 1) + 
  geom_vline(xintercept = 0, 
             linetype="dotted", 
             color = "blue", 
             size=1) + 
  xlab("Log2 Fold Change (95% CIs)") + 
  ylab("Genes") + 
  ggtitle("Regulation of Genes Associated with Metastasis in Bladder Cancer")

pdf("../results/06_conf_int_plot.pdf", height = 4)
print(conf_int_plot)
dev.off()
```

We now want to investigate the proportion of Current Smokers, Former Smokers, and Non-smokers for each gene. Additionally, we want to compare these proportions based on how the gene expression is regulated (whether a gene is up-regulated or down-regulated).

```{r}
smoking_plot <- data |>
  filter(Metastasis == 1) |>
  filter(p_value < 0.001) |>
  mutate(Regulation = case_when(log2_fold_change_sample > 0 ~ "Samples with upregulation",
                                 log2_fold_change_sample < 0 ~ "Samples with downregulation"),
         Avg_Regulation = case_when(log2_fold_change_avg < 0 ~ "Risk if downregulated",
                                    log2_fold_change_avg > 0 ~ "Risk if upregulated")) |>
    ggplot(aes(y = reorder(gene,
                         log2_fold_change_sample, 
                         FUN = mean),
               fill = Smoking)) +
      geom_bar(position = "fill") +
      facet_grid(Avg_Regulation ~ Regulation, scales="free", space = "free") +
      labs(x = "Percentage", y = "Genes") +
      ggtitle("") 

pdf("../results/06_smoking_plot.pdf", height = 4)
print(smoking_plot)
dev.off()
```
