---
title: "01_load.qmd"
format: html
editor: visual
---

## Load packages

```{r}
#| output: false
#| warning: false
library(tidyverse)
library(httr)
library(readr)
```

## Load data

```{r}
data <- read_tsv("../data/data_joined.tsv")


head(data)
```

## Clean data

```{r}
# We keep GSM number as the patient identifier.
# We need to make sure all the columns are in a correct format! See RC_Histology, only one



```

## Analysis

```{r}
#|warning: false
# Using Recurrence / DOD (death of disease) as indication (case vs control)
# Can be changed later

data_geneexp <- data |>
  mutate(y = case_when(`Recurrence/DOD` == "Yes" ~ 1,
                       `Recurrence/DOD` == "No" ~ 0)) 

data_geneexp_2 <- 
  data_geneexp |> 
  select(!GEO:Cluster)


data_long <- data_geneexp_2 |> 
  pivot_longer(
    cols=-y,
    names_to = "gene",
    values_to = "gene_expression"
  )


#### AM I DOING THIS RIGHT??? THE log2Fold CHANGE IS QUITE SMALL? ####
data_long_log2 <- data_long |>  
  arrange(y) |> 
  group_by(gene)  |> 
  mutate(log2_fold_change = log2(gene_expression[2] / gene_expression[1]))

# Make dataset nested:
data_long_nested <- data_long_log2 |> 
  group_by(gene) |> 
  nest() |> 
  ungroup()

# Add variable containing linear model data log2 vs outcome for each gene.
data_long_nested <- data_long_nested |> 
  group_by() |> 
  mutate(model_object = map(.x = data, 
                            .f = ~lm(formula = log2_fold_change ~ y, 
                                     data = .x)))

# Add variable containing tidy data (statistical data for linear model)
data_long_nested <- data_long_nested |> 
  group_by() |> 
  mutate(model_object_tidy = map(.x = model_object,
                                 .f = ~tidy(.x, conf.int = TRUE,
                                            conf.level = 0.95)))

# Unnest the tidy data (statistical data): 
data_long_nested <- data_long_nested |> 
  unnest(model_object_tidy)

tail(data_long_nested)

# Remove redundant columns: 
data_long_stat <- data_long_nested |> 
  filter(term == "(Intercept)") |> 
  select(c(gene, p.value, estimate, conf.low, conf.high))

head(data_long_stat)

# Add significance definintion
data_long_stat <- data_long_stat |> 
  group_by() |> 
  mutate(q.value = p.adjust(p.value),
         is_significant = case_when(q.value > 0.05 ~ "no",
                                    q.value <= 0.05 ~ "yes"))

length(data_long_stat$is_significant == "yes")


data_long_log2[(data_long_log2$gene == "209354_at"),]

data_long_nested |> 
  filter(gene == "221218_s_at") |> 
  pull(model_object_tidy)

head(data_long_nested)
```
