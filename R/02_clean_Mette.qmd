---
title: "01_load.qmd"
format: html
editor: visual
---

## Load packages

```{r}
#| output: false
#| warning: false
library(tidyverse)
library(httr)
#library(readr)
```

## Load data

```{r}
data <- read_tsv("../data/data_joined.tsv")

metadata_to_rem <- colnames(data)[25:]
metadata_to_rem <- metadata_to_rem[metadata_to_rem != "Smoking"]

head(data)

genes <- colnames(data)[25:length(colnames(data))]

columns_to_keep <- c("Metastasis", "Smoking", genes)
```

## Clean Data:

```{r}
# Cleaning the data:
data_clean <- data |>
  relocate(Metastasis) |>
  select(all_of(columns_to_keep))

# Making the dataset long:
data_clean_long <- data_clean |> 
  pivot_longer(
    cols=-c(Metastasis, Smoking),
    names_to = "gene",
    values_to = "gene_expression") 

data_clean_long
```

## Analysis 1: Volcano plot

```{r}
# Selecting genes with different average gene expression based on the metastatic and non-metastatic cases:
gene_variability <- data_clean_long %>%
  group_by(gene) |>
  summarise(mean_0 = mean(gene_expression[Metastasis == 0]), 
            mean_1 = mean(gene_expression[Metastasis == 1])) |>
  mutate(mean_dif = mean_0 - mean_1) |>
  filter(mean_dif != 0) |>
  pull(gene)

# Calculate the t-test p value of the gene_expression by comparring recurrent and non-recurrent for each gene:
gene_diff_exp <- data_clean_long %>%
  filter(gene %in% gene_variability) %>% # Filtering for genes that differenly expressed.
  group_by(gene) %>%
  mutate(p_value = t.test(gene_expression[Metastasis == 1], 
                          gene_expression[Metastasis == 0])$p.value) %>%
  mutate(mean_1 = mean(gene_expression[Metastasis == 1]),
         mean_0 = mean(gene_expression[Metastasis == 0])) %>%
  mutate(log2_fold_change = log2(mean_1) - log2(mean_0)) |> # Calculating the log2 fold change by using the mean.
  mutate(is_significant = case_when(p_value > 0.01 ~ "no",
                                    p_value <= 0.01 ~ "yes"))


head(gene_diff_exp)

unique(gene_diff_exp$Smoking)
```

```{r}
gene_diff_exp |> 
  mutate(log_10_p = -log10(p_value)) |> 
  ggplot(mapping = aes(x = log2_fold_change,
                       y = log_10_p,
                       color=is_significant)) +
  geom_point(size = 1) +
  xlim(-0.2,0.2) +
  ylim(0,3) +
  theme(legend.position = "none") + 
  theme_minimal() +
  labs(title="Genes titlea", 
       subtitle = "Genes highlighted in turquoise are significant",
     x = "Estimates",
     caption = "Data from DOI: doi", 
     y = "-log10(p)")
```

```{r}
gene_diff_exp |> 
  mutate(log_10_p = -log10(p_value)) |> 
  sample_n(20) |> 
  ggplot(mapping = aes(x = log2_fold_change,
                       y = log_10_p,
                       color=Smoking)) +
  geom_point(size = 1) +
  geom_hline(yintercept=2) +
  xlim(-0.2,0.2) +
  ylim(0,3) +
  theme(legend.position = "none") + 
  theme_minimal() +
  labs(title="Genes titlea", 
       subtitle = "Genes highlighted in turquoise are significant",
     x = "Estimates",
     caption = "Data from DOI: doi", 
     y = "-log10(p)")
```

```{r}
-log10(0.01)
```

## Analysis 2: Smoking vs gene upregulation
